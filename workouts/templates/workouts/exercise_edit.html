{% extends "base.html" %}

{% block title %}Edit — {{ exercise.name }}{% endblock %}

{% block extra_css %}
<style>
    .media-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .media-item {
        position: relative;
    }
    .media-item img, .media-item video {
        max-width: 200px;
        border-radius: 6px;
    }
    .media-delete-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        line-height: 24px;
        text-align: center;
    }
    .media-delete-btn:hover { background: #b91c1c; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 20px;">Edit Exercise</h2>

    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="submit" class="btn">Save Changes</button>
            <a href="{% url 'exercise_detail' exercise.pk %}" class="btn" style="background: #6b7280;">Cancel</a>
        </div>
    </form>

    <!-- Media management -->
    {% if exercise.media.all %}
    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
        <h3>Media</h3>
        <div class="media-grid">
            {% for m in exercise.media.all %}
            <div class="media-item" data-media-id="{{ m.id }}">
                {% if m.is_video %}
                    <video src="/media/{{ m.file.name }}" controls></video>
                {% else %}
                    <img src="/media/{{ m.file.name }}" alt="{{ exercise.name }}">
                {% endif %}
                {% if user.is_superuser %}
                    <button class="media-delete-btn" onclick="deleteMedia({{ m.id }}, this)">✕</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if user.is_superuser %}
    <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
        <h3>Upload Media</h3>
        <p style="font-size: 12px; color: #888; margin-bottom: 5px;">Images (jpg, png, gif, webp) or videos (mp4, mov, webm, avi)</p>
        <input type="file" id="media-upload" multiple accept="image/*,video/*">
        <button type="button" class="btn" onclick="uploadMedia()" style="margin-top: 5px;">Upload</button>
    </div>
    {% endif %}
</div>

{% if user.is_superuser %}
<script>
function uploadMedia() {
    const input = document.getElementById('media-upload');
    if (!input.files.length) return;
    const formData = new FormData();
    formData.append('target_type', 'exercise');
    formData.append('target_id', '{{ exercise.pk }}');
    for (const f of input.files) formData.append('files', f);
    fetch('{% url "api_upload_media" %}', {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: formData,
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') location.reload();
        else alert(data.message);
    })
    .catch(() => alert('Upload failed.'));
}

function deleteMedia(mediaId, btn) {
    if (!confirm('Delete this file?')) return;
    fetch('{% url "api_delete_media" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({target_type: 'exercise', media_id: mediaId}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') btn.closest('.media-item').remove();
        else alert(data.message);
    })
    .catch(() => alert('Delete failed.'));
}
</script>
{% endif %}
{% endblock %}